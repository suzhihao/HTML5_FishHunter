<!DOCTYPE html>   
<head>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
   
<title>fishhunter</title> 


</head>  
<body onload="draw('canvas')">  

<canvas id="canvas" width=1000 height=1600/>

</body>  

<script>

 	if(window.DeviceMotionEvent){  
            window.addEventListener("devicemotion",deviceMotionHandler,false);  
       }else{  
         alert("本设备不支持重力感应");  
       }
	 //判断手机是安卓还是ios
	var u = navigator.userAgent, app = navigator.appVersion;
	//var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //android终端或者uc浏览器
	var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端

	
	var myCanvas;//about canvas
	var width,height;
	var context;
	var context_fish;
	
	var time=1200;//game's time 20s*20=400

	var x=300,y=650;//fish position
	var nx=150,ny=350;//net position
	var vx=0.0,vy=0.0;//fish speed
	var fish_sizex=700,fish_sizey=600,net_sizex=700,net_sizey=800;//fish net size
	var distance=0.0;
	var mousex,mousey;
	
	var nowinTime=99.0;//controll fish's action
	var inTime=1.5//an interval
	var rotate_time=0.5;//rotate time in an interval
	var angle = 1.5*Math.PI;	
	var x_rotate,y_rotate;
	var changeangle=0.0;
	
	var score=0;//catch score
	var gaintime=0;
	var needgaintime=20;//need time to catch
	var distime=0;//disappear after catch
	
	myCanvas = document.createElement("canvas");
	myCanvas.setAttribute("width", fish_sizex);
	myCanvas.setAttribute("height", fish_sizey);

	//开始游戏按钮
	var startButton = document.createElement("canvas");
	startButton.setAttribute("width",330);
	startButton.setAttribute("height", 200);

	//游戏资源
	var image_net= new Image();		
	var imgs = new Array();
	var image = new Image();
	var pic_num=1;

function draw(id)
{
	//some old unused code
/*  var myCanvas = "<canvas id='canvas' width='" + screen.availWidth + "px' height='"+ screen.availHeight + "px'></canvas>";
	document.body.insertAdjacentHTML("beforeEnd", myCanvas);
	var myCanvas = document.createElement("canvas");
	myCanvas.setAttribute("width", screen.availWidth);
	myCanvas.setAttribute("height", screen.availHeight);
	myCanvas.setAttribute("id", "canvas");
	document.body.appendChild(myCanvas);*/
	
	//加载资源
	loadImg();

	//获取游戏场景canvas
	var canvas = document.getElementById(id);
    context = canvas.getContext('2d'); 
  	width=canvas.width;
    height=canvas.height;
	
	//获取鱼的canvas
	context_fish = myCanvas.getContext('2d');
	context_fish.translate(0.5*fish_sizex,0.5*fish_sizey);
    
	//获取开始按钮canvas
	context_start = startButton.getContext('2d');
	context_start.font='italic 100px sans-serif';
	context_start.fillStyle='black';
	context_start.fillText("Start",50,130);
	context_start.beginPath();
	context_start.moveTo(0,0);
	context_start.lineTo(330,0);
	context_start.lineTo(330,200);
	context_start.lineTo(0,200);
	context_start.lineTo(0,0);
	context_start.stroke();
	context.drawImage(startButton,320,500);
	
	//点击开始游戏，触发事件
	canvas.onclick = function(e){
		mousex=e.pageX;
		mousey=e.pageY;
		getPointOnCanvas(canvas,mousex,mousey);
		if(mousex>320&&mousex<650&&mousey>500&&mousey<700){
			setInterval(rotate,50);
		}
	};
}
function rotate()
{   

	if (time>0)
	{
		//calculate time
		time--;
		distime--;
		
		//clear
		context.clearRect(0,0,width,height);
		context_fish.clearRect(-0.5*fish_sizex,-0.5*fish_sizey,fish_sizex,fish_sizey);
		
		//draw net
		context.drawImage(image_net,nx,ny,net_sizex,net_sizey);

		//show text and change color in emergency
		if(time<100)
		{
			context.fillStyle='red';
		}else
		{
			context.fillStyle='green';
		}		
		context.font='italic 80px sans-serif';
		context.textBaseline='top';		
		context.fillText("time: "+parseInt(time/20),0,0);
		context.fillStyle='blue';
		context.fillText("score: "+score,width-350,0);
		context.font='italic 30px sans-serif';
		context.fillStyle='black';
		context.fillText("version: 1.1.8",width-350,150);
		//rotate
		nowinTime+=0.05;		
		if (nowinTime>=inTime)
		{
			inTime=Math.random()+1.0;
			changeangle=Math.PI*Math.random()-0.5*Math.PI;
			if (angle<Math.PI && y<100)
			{
				if (angle<0.5*Math.PI)
				{
					changeangle=2*(0-angle);
				}
				else
				{
					changeangle=2*(Math.PI-angle);
				}
			}
			if (angle>=Math.PI && y+fish_sizey*0.7>height-200)
			{
				if (angle>1.5*Math.PI)
				{
					changeangle=2*(2*Math.PI-angle);
				}
				else
				{
					changeangle=2*(Math.PI-angle);
				}
			}
			if ((angle<0.5*Math.PI|| angle>1.5*Math.PI) && x<100)
			{
				if (angle<0.5*Math.PI)
				{
					changeangle=2*(0.5*Math.PI-angle);
				}
				else
				{
					changeangle=2*(1.5*Math.PI-angle);
				}			
			}
			if (angle>=0.5*Math.PI&& angle<=1.5*Math.PI && x+fish_sizex*0.6>width-200)
			{
				if (angle<Math.PI)
				{
					changeangle=2*(0.5*Math.PI-angle);
				}
				else
				{
					changeangle=2*(1.5*Math.PI-angle);
				}
			}
			nowinTime = 0;
		}
		if(nowinTime<inTime*0.5)
		{
			angle=angle+changeangle/20-2*Math.PI;	
			while(angle<0)
			{
				angle+=2*Math.PI;
			}
		    context_fish.rotate(changeangle/20);
		}
		
		//move					
		vx=Math.cos(angle)*(-15);
		vy=Math.sin(angle)*(-15);
		x+=parseInt(vx);
		y+=parseInt(vy);
		
		//controll net
		nx+=x_rotate*10;
		ny-=y_rotate*10;
		
		//fish_boundary
		if(x<-fish_sizex*0.4)
		{
			x=-fish_sizex*0.4;			
			
		}
		if(y<-fish_sizey*0.3)
		{
			y=-fish_sizey*0.3;
			
		}
		if(x+fish_sizex*0.6>width)
		{
			x=width-fish_sizex*0.6;
			
		}
		if(y+fish_sizey*0.7>height)
		{
			y=height-fish_sizey*0.7;
			
		}
		
		//net_boundary
		if(nx<-net_sizex*0.4)
		{
			nx=-net_sizex*0.4;
		}
		if(ny<-net_sizey*0.3)
		{
			ny=-net_sizey*0.3;
		}
		if(nx+net_sizex*0.5>width)
		{
			nx=width-net_sizex*0.5;
		}
		if(ny+net_sizey*0.5>height)
		{
			ny=height-net_sizey*0.5;
		}
		
		//draw
		if(pic_num<=27){
			pic_num++;
		}else{
			pic_num = 1;
		}
		image=imgs[pic_num-1];
		context_fish.drawImage(image,-0.5*fish_sizex,-0.5*fish_sizey,fish_sizex,fish_sizey);
		if(distime<0)
		{			
			context.drawImage(myCanvas,x,y,fish_sizex,fish_sizey);
		}else{
			context.font='italic 100px sans-serif';
			context.fillStyle='black';
			context.fillText("+1",0.5*width-50,0.5*height);
		}
		
		
		//gain
		distance = Math.sqrt(Math.pow((x+fish_sizex*0.5-nx-net_sizex*0.5),2)+Math.pow((y+fish_sizey*0.5-ny-net_sizey*0.4),2));
		if(distance<net_sizex*0.4 && distime<=0)
		{
			gaintime++;
			if(gaintime==needgaintime)
			{
				score++;
				gaintime=0;
				x=0.5*Math.random()*width;
			    y=0.5*Math.random()*height;
				
				//relocate
				changeangle=Math.PI*Math.random()-0.5*Math.PI;
				angle=angle+changeangle-2*Math.PI;
				while(angle<0)
			    {
				angle+=2*Math.PI;
			    }
				context_fish.rotate(changeangle);
				nowinTime=99.0;
				vx=0;
				vy=0;
				
				//disappear
				if(distime<0)
				{
					distime=15;
				}				
			}
		}
		else
		{
			gaintime=0;
		}		
	}else{
		alert('time out! score: '+score);
		time=1200;
	}
}

//加载资源
function loadImg(){
	try{
		var fish_png;
		image_net.src = "net.png";
		for(pic_num=1;pic_num<=27;pic_num++){
			if(pic_num<10){
				fish_png ="fish_png/fish_00"+pic_num+".png";
				pic_num++;
			}else{
				fish_png ="fish_png/fish_0"+pic_num+".png";
				pic_num++;
			}
			image.src = fish_png;
			imgs[pic_num-1]=image;
		}
	}catch(e){
		alert("资源加载失败！");
	}
}

//获取鼠标位置
function getPointOnCanvas(canvas,mousex,mousey){ 
	var bbox =canvas.getBoundingClientRect(); 
	mousex=mousex- bbox.left *(canvas.width / bbox.width);
	mousey=mousey - bbox.top * (canvas.height / bbox.height);
} 

//获取重力感应
function deviceMotionHandler(eventData){  
	var acceleration = eventData.accelerationIncludingGravity; 
    if(isiOS){
		x_rotate=acceleration.x;  
        y_rotate=acceleration.y; 
	}else{
		x_rotate=-acceleration.x;  
        y_rotate=-acceleration.y;
	}
 }  
</script>  
</html>
